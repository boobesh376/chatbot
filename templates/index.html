<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FibroGuide: IPF Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">      

    <style>
        /* INLINE STYLES FOR BUTTON PLACEMENT (Copied from your previous HTML) */
        .settings-button-link {
            position: absolute;
            top: 15px;
            right: 110px;
            background-color: #1a73e8;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.3s;
            z-index: 10;
        }
        .settings-button-link:hover {
            background-color: #0d5cb3;
        }
        
        /* Style for the image preview in the chat bar */
        #image-preview-container {
            display: none; /* Controlled by JS */
            align-items: center;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 12px;
            background-color: #f9f9f9;
            margin-right: 10px;
            flex-shrink: 0;
            max-width: 250px;
        }
        #image-preview {
            max-width: 40px;
            max-height: 40px;
            border-radius: 4px;
            object-fit: contain;
        }
        #file-name-display {
            font-size: 0.8em;
            color: #555;
            margin-left: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .remove-image-button {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .remove-image-button:hover {
            background-color: #d32f2f;
        }
        
        /* Fix the input area layout for the new style */
        .input-area {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping if items don't fit */
            align-items: flex-end;
            width: 100%;
            margin-top: 10px;
            
            /* NEW CHATGPT STYLE CONTAINER */
            border: 1px solid #ccc;
            border-radius: 25px; 
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            background-color: #fff;
        }

        .input-area textarea {
            border: none;
            min-height: 40px;
            max-height: 200px;
            padding: 10px;
            margin: 0 5px;
            resize: none;
            flex-grow: 1; /* Allow textarea to take up remaining space */
        }
        
        /* Ensure the button aligns with the new layout */
        .input-area button {
            width: auto;
            align-self: flex-end;
            flex-shrink: 0;
        }
        
        /* ATTACHMENT MENU STYLES (Copied from previous response) */
        .attach-menu-wrapper {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            padding-left: 5px;
        }

        .attach-button {
            background: none;
            border: none;
            color: #666;
            font-size: 1.4em;
            padding: 0 10px;
            cursor: pointer;
            transition: color 0.2s;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .attach-button:hover {
            color: #1a73e8; /* Primary Blue */
        }

        .upload-menu {
            position: absolute;
            bottom: 55px;
            left: 0;
            z-index: 10;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 180px;
            display: none;
        }

        .upload-menu[aria-hidden="false"] {
            display: block;
        }

        .menu-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 20px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            color: #333;
            font-size: 0.95em;
            transition: background-color 0.2s;
            text-decoration: none;
        }

        .menu-item:hover {
            background-color: #f0f0f0;
        }

        .menu-item i {
            margin-right: 12px;
            color: #1a73e8; 
        }

    </style>
</head>
<body>
    <div class="container header-bar">
        
        <a href="{{ url_for('settings_page') }}" class="settings-button-link">
            Settings
        </a>
        <a href="{{ url_for('logout') }}" class="logout-button">
            Logout
        </a>
        
        <h1> 🩺 FibroGuide: IPF Chatbot</h1>
        
        <div class="instructions">
            <p><strong>Welcome!</strong> This is a Hybrid AI system. Ask a general question, or submit structured data for an XAI analysis.</p>
            <p><strong>XAI Analysis:</strong> Enter patient data in a single, simple English sentence and/or upload a prescription image. The AI will extract the features.</p>
            
            <p class="disclaimer-paragraph">
                <span class="disclaimer-word">Disclaimer:</span>
                This tool is for informational purposes only. Consult a healthcare provider for medical advice.
            </p>
            
            <p><strong>Example Input for Analysis:</strong></p>
            <pre class="example-input">"Patient is 72, gut data shows Bacteroides 0.25 and Firmicutes 0.50, and Metabolite A is 12.5." (Upload Rx image for medications)</pre>
        </div>
        
        <div id="chat-window">
            <div class="message bot-message initial-message">
                Hello! I'm FibroGuide, your Clinical Decision Support Assistant. How can I assist with IPF data or answer a question today?
            </div>
        </div>

        <div class="input-area">
            
            <div class="attach-menu-wrapper">
                <button id="attach-toggle" class="attach-button" aria-expanded="false" aria-controls="upload-menu">
                    <i class="fas fa-plus"></i>
                </button>
                
                <div id="upload-menu" class="upload-menu" role="menu" aria-hidden="true">
                    
                    <label class="menu-item" for="upload-file-input">
                        <i class="fas fa-file-upload"></i> Upload File
                    </label>
                    <input type="file" id="upload-file-input" style="display: none;" accept="image/*" onchange="displayFile(this)">
                    
                    <button id="take-photo-button" class="menu-item" style="display: none;">
                        <i class="fas fa-camera"></i> Take Photo
                    </button>
                </div>
            </div>
            
            <div id="image-preview-container">
                <img id="image-preview" src="#" alt="Image Preview">
                <span id="file-name-display"></span>
                <button type="button" class="remove-image-button" onclick="removeImage()">✖</button>
            </div>
            
            <textarea id="user-input" placeholder="Enter patient details or a general query..."></textarea>
            
            <button onclick="sendQuery()">Send</button>
        </div>
        
    </div>

<script>
    let base64Image = null; // Stores the Base64 image data (CLEANED)
    let currentChatTone = 'clinical'; // Default tone, fetched from settings

    // --- UTILITY AND HISTORY FUNCTIONS (Keeping your existing logic) ---

    function getChatTone() {
        return localStorage.getItem('chatTone') || 'clinical'; 
    }

    function scrollToBottom() {
        const chatWindow = document.getElementById('chat-window');
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function addMessage(sender, content, isReport = false) {
        const chatWindow = document.getElementById('chat-window');
        const messageDiv = document.createElement('div');
        
        if (chatWindow.querySelector('.initial-message') && sender !== 'bot-processing') {
            chatWindow.innerHTML = '';
        }
        
        if (sender === 'user') {
            messageDiv.className = 'message user-message';
            // Use innerHTML to respect any image placeholders added in sendQuery
            messageDiv.innerHTML = content; 
        } else if (isReport) {
            messageDiv.className = 'message report-card';
            messageDiv.innerHTML = content;
        } else if (sender === 'bot-processing') {
            messageDiv.className = 'message bot-message processing-message';
            messageDiv.innerText = content;
        } else {
            messageDiv.className = 'message bot-message';
            messageDiv.innerHTML = content;
        }
        
        chatWindow.appendChild(messageDiv);
        scrollToBottom();
        
        if (sender !== 'bot-processing') {
            saveHistory();
        }
    }

    function saveHistory() {
        const chatWindow = document.getElementById('chat-window');
        localStorage.setItem('chatHistory', chatWindow.innerHTML);
    }

    function loadHistory() {
        const history = localStorage.getItem('chatHistory');
        const chatWindow = document.getElementById('chat-window');
        
        if (history) {
            chatWindow.innerHTML = history;
            scrollToBottom();
        } else {
             if (!chatWindow.querySelector('.initial-message')) {
                 chatWindow.innerHTML = `
                    <div class="message bot-message initial-message">
                        Hello! I'm FibroGuide, your Clinical Decision Support Assistant. How can I assist with IPF data or answer a question today?
                    </div>
                `;
            }
        }
    }

    // CRITICAL FIX 1: Converts an uploaded File object to a Base64 string (without prefix)
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                // IMPORTANT: Split and get the second part to remove the "data:image/jpeg;base64," prefix
                const cleanedBase64 = reader.result.split(',')[1];
                resolve(cleanedBase64);
            }; 
            reader.onerror = error => reject(error);
        });
    }

    // CRITICAL FIX 2: Displays the selected file and converts it to Base64
    async function displayFile(input) {
        const fileNameDisplay = document.getElementById('file-name-display');
        const imagePreview = document.getElementById('image-preview');
        const previewContainer = document.getElementById('image-preview-container');
        const file = input.files[0];
        
        // Hide menu after file selection
        document.getElementById('attach-toggle').setAttribute('aria-expanded', 'false');
        document.getElementById('upload-menu').setAttribute('aria-hidden', 'true');
        
        if (file) {
            if (file.size > 5 * 1024 * 1024) { // Max 5MB for Gemini Vision
                alert("File size exceeds 5MB. Please choose a smaller file.");
                input.value = ""; 
                removeImage();
                return;
            }
            
            fileNameDisplay.textContent = file.name;
            previewContainer.style.display = 'flex'; 

            // Display image preview
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block'; 
            };
            reader.readAsDataURL(file); // Reads file to display preview (with prefix)

            // Convert and store the CLEANED base64 data for the API call
            try {
                base64Image = await fileToBase64(file);
            } catch (error) {
                console.error("Error converting file to Base64:", error);
                base64Image = null;
                alert("Error processing file.");
            }

        } else {
            removeImage();
        }
    }

    function removeImage() {
        document.getElementById('upload-file-input').value = ''; // Clear file input
        document.getElementById('file-name-display').textContent = '';
        document.getElementById('image-preview').src = '#';
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('image-preview-container').style.display = 'none';
        base64Image = null; // Clear base64 data
    }


    // --- Main Chat Submission Handler (CRITICAL FIX 3) ---
    async function sendQuery() {
        const userInputElement = document.getElementById('user-input');
        const userQuery = userInputElement.value.trim();
        
        if (!userQuery && !base64Image) {
            alert("Please enter patient data or upload a prescription image to start the XAI analysis.");
            return;
        }

        // --- FINAL ROBUST LOGIC FOR BACKEND PROMPT ---
        let finalQueryText = userQuery;
        let userMessageContent = userQuery;
        
        if (base64Image) {
            // If image is provided, construct a detailed instruction for Gemini.
            // This is the instruction that gets sent to the API along with the image
            finalQueryText = `
                **INSTRUCTION FOR XAI:** Analyze the patient profile.
                1. EXTRACT: All medication names and dosages from the attached image.
                2. EXTRACT: Age, Total Meds (if not in image), Alpha Diversity, Microbial Metabolite A Level, Bacteroides Abundance, and Firmicutes Abundance from the following TEXT: "${userQuery}"
                3. PROVIDE: A single pipe-separated list of ALL extracted data for parsing.
            `.trim();
            
            // This is what the user sees in the chat window
            userMessageContent = (userQuery ? userQuery + " " : "") + 
                                 `<span class="image-indicator">(Image: ${document.getElementById('file-name-display').textContent || 'Attached'})</span>`;

        } else {
            // ONLY text is provided (Standard XAI or General Chat)
            finalQueryText = userQuery;
            userMessageContent = userQuery;
        }
        // --- END ROBUST LOGIC ---


        // 1. Display User Message 
        addMessage('user', userMessageContent);
        userInputElement.value = '';
        userInputElement.style.height = 'auto'; // Reset textarea height

        
        const processingMessage = "Processing request... (Analysis may take a few seconds)";
        addMessage('bot-processing', processingMessage);

        try {
            // 2. Construct Payload
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: finalQueryText, 
                    image_data: base64Image, // Send CLEANED base64 data (null if not set)
                    chat_tone: getChatTone() 
                }),
            });

            const data = await response.json();
            
            // Remove the processing message before displaying the actual response
            const chatWindow = document.getElementById('chat-window');
            const processingMsgDiv = chatWindow.querySelector('.processing-message:last-child');
            if (processingMsgDiv) {
                chatWindow.removeChild(processingMsgDiv);
            }

            // 3. Handle Response
            if (response.ok) {
                const isReport = data.response.includes("FibroGuide XAI Analysis Report");
                addMessage('bot', data.response, isReport);
            } else {
                addMessage('bot', '❌ ERROR: ' + (data.error || data.response || "An unknown error occurred."));
            }

        } catch (error) {
            console.error('Network or Fetch Error:', error);
            const chatWindow = document.getElementById('chat-window');
            const processingMsgDiv = chatWindow.querySelector('.processing-message:last-child');
            if (processingMsgDiv) {
                chatWindow.removeChild(processingMsgDiv);
            }
            addMessage('bot', '❌ FATAL ERROR: Could not connect to the Flask server. Check your console and server status.');
        } finally {
            removeImage(); // Clear file input/base64 data after submission
        }
    }
    
    // --- NEW UI INTERACTIVITY LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        
        const attachToggle = document.getElementById('attach-toggle');
        const uploadMenu = document.getElementById('upload-menu');
        const takePhotoButton = document.getElementById('take-photo-button');
        const userInputElement = document.getElementById('user-input');

        // Auto-resize textarea
        userInputElement.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // 1. Check for Camera Access
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const hasCamera = devices.some(device => device.kind === 'videoinput');
                    if (hasCamera) {
                        takePhotoButton.style.display = 'flex'; 
                    }
                });
        }
        
        // 2. Menu Toggle Logic
        attachToggle.addEventListener('click', function() {
            const isExpanded = attachToggle.getAttribute('aria-expanded') === 'true';
            attachToggle.setAttribute('aria-expanded', !isExpanded);
            uploadMenu.setAttribute('aria-hidden', isExpanded);
        });

        // 3. Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!uploadMenu.contains(event.target) && !attachToggle.contains(event.target)) {
                attachToggle.setAttribute('aria-expanded', 'false');
                uploadMenu.setAttribute('aria-hidden', 'true');
            }
        });
        
        // 4. Handle Take Photo button click (Just a placeholder for now)
        takePhotoButton.addEventListener('click', function() {
            alert("Camera feature needs advanced implementation (e.g., streaming video feed). Please use 'Upload File' for images.");
            attachToggle.setAttribute('aria-expanded', 'false');
            uploadMenu.setAttribute('aria-hidden', 'true');
        });
        
        // --- Download History Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('download') === 'true') {
            history.replaceState({}, document.title, window.location.pathname);
            downloadChatHistory(); 
        }
        
        function downloadChatHistory() {
            const chatWindow = document.getElementById('chat-window');
            const messages = chatWindow.querySelectorAll('.message:not(.processing-message)');
            let historyText = "--- FibroGuide IPF Chat History ---\n";
            historyText += "Date: " + new Date().toLocaleString() + "\n\n";

            messages.forEach(msg => {
                sender = msg.classList.contains('user-message') ? "USER" : "BOT";
                let content = msg.innerText.trim();
                if (msg.classList.contains('report-card') || content.includes('FibroGuide XAI Analysis Report')) {
                    content = "--- XAI ANALYSIS REPORT ---\n" + content;
                }
                historyText += `[${sender}]: ${content}\n\n`;
            });
            
            const blob = new Blob([historyText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FibroGuide_Chat_History_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    });

</script>
</body>
</html>